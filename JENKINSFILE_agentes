pipeline {
    agent none

    environment {
        DEPLOY_ENV = 'production'
        REGION = 'us-east-1'
        STACK_NAME = 'todo-list-production'
    }

    stages {
        stage('Get Code') {
            agent { label 'built-in' }
            steps {
                checkout scm
                
                script {
                    // if master -> production branch. else -> staging branch.
                    def configBranch = (env.BRANCH_NAME == 'master') ? 'production' : 'staging'
                    echo "ConfiguraciÃ³n detectada para: ${configBranch}"
                    
                    bat "git clone -b ${configBranch} https://github.com/santvaz/todo-list-aws-config.git temp_cfg"
                    
                    bat "move temp_cfg\\samconfig.toml ."
                    
                    bat "rd /s /q temp_cfg"
                }
                stash name: 'code', includes: '**'
            }    
        }

        stage('Static Test') {
            agent { label 'agente-estatico' } // AGENTE 1
            steps {
                bat 'whoami & hostname'
                unstash 'code'
                bat 'python -m pip install flake8 bandit'
                bat 'python -m flake8 src --statistics'
                bat 'python -m bandit -r src -f txt -o bandit-report.txt'
            }
        }

        stage('Build & Deploy') {
            agent { label 'built-in' }
            steps {
                bat 'whoami & hostname'
                unstash 'code'
                withCredentials([usernamePassword(credentialsId: 'aws-credentials', passwordVariable: 'AWS_SECRET_ACCESS_KEY', usernameVariable: 'AWS_ACCESS_KEY_ID')]) {
                    bat 'sam build'
                    bat "sam deploy --capabilities CAPABILITY_IAM --no-confirm-changeset --no-fail-on-empty-changeset"
                    
                    bat "aws cloudformation describe-stacks --stack-name %STACK_NAME% --region %REGION% --query \"Stacks[0].Outputs[?OutputKey=='ListTodosApi'].OutputValue\" --output text > api_url.txt"
                }
                stash name: 'api_data', includes: 'api_url.txt'
                cleanWs()
            }
        }

        stage('Rest Test') {
            agent { label 'agente-pruebas' } // AGENTE 2
            steps {
                bat 'whoami & hostname'
                unstash 'api_data'
                script {
                    def apiUrl = readFile('api_url.txt').trim()
                    echo "Ejecutando pruebas contra: ${apiUrl}"
                    
                    bat "curl -I -X GET ${apiUrl}"
                    bat "curl -s -o /dev/null -w \"%%{http_code}\" ${apiUrl} | findstr \"200\""
                }
            }
        }
    }
    
    post {
        always {
            echo "Limpiando espacios de trabajo..."
        }
    }
}